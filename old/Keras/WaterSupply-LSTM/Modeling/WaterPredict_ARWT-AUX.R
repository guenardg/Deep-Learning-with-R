#!/usr/bin/Rscript
##
## Il faut ouvrir un tunnel tcp pour passer le h2o:
## system("ssh -L 54321:127.0.0.1:54321 -N gguenard@ada.fil.umontreal.ca")
## Puis lancer h2o:
## java -jar ~/R/x86_64-redhat-linux-gnu-library/3.4/h2o/java/h2o.jar &> ~/current_h2o_session.log &
## Et puis monter un 
##
## sqliteCon <- DBI::dbConnect(RSQLite::SQLite(),"./RAW/PIO_Model_data.sqlite")
## localH2O <- h2o::h2o.init(ip='localhost',port=54321,max_mem_size='32G',nthreads=-1L,enable_assertions=FALSE)
## h2o::h2o.clusterInfo()
## h2o::h2o.shutdown(prompt=FALSE)
##
init <- function() {
    library(keras)
    ## library(RSQLite)
    ## drv <<- drv <- SQLite()
    ## con <<- dbConnect(drv,dbname="../Data/BasinSupply_ARWT.sqlite",flags=SQLITE_RWC)
}
##
closeall <- function() {
    ## dbDisconnect(con)
    ## dbUnloadDriver(drv)
    ## rm(con,drv,envir=.GlobalEnv)
    ## detach("package:RSQLite", unload=TRUE)
    detach("package:keras", unload=TRUE)
}
##








##
setClass("tsmts",representation(ts="ts",timestamp="POSIXt"))
##
tsmts <- function(x,timestamp) {
    if(!any(class(timestamp)=="POSIXt"))
        stop("Parameter 'timestamp' must be POSIX timestamp (class 'POSIXt')!")
    rng <- as.numeric(range(timestamp))
    deltat <- diff(rng)/(length(timestamp)+1L)
    return(new("tsmts",
               ts=ts(data=x,start=rng[1L]+deltat,end=rng[2L]-deltat,deltat=deltat),
               timestamp=timestamp))
}
##
setMethod("print",signature(x="tsmts"),
          function(x,...) {
              if(NCOL(x@ts)>1L)
                  print(data.frame(time=time(x@ts),timestamp=x@timestamp,x@ts))
              else
                  print(data.frame(time=time(x@ts),timestamp=x@timestamp,series=x@ts))
              return(invisible(NULL))
          })
##
setMethod("[",signature("tsmts"),
          function(x,i,j,...,drop=TRUE) {
              if(missing(i)) {
                  if(missing(j))
                      return(x)
                  else
                      return(new("tsmts",
                             ts=x@ts[,j],
                             timestamp=x@timestamp))
              } else {
                  if(is.character(i))
                      i <- match(i,rownames(x@ts))
                  if(is.logical(i))
                      i <- which(i)
                  if(length(i)>1L) {
                      ## Multiple slide elements may be returnes as tsmts (1),
                      if(length(unique(diff(i)))==1L) {
                          ## Returns a tsmts only if the slice is continuous (2),
                          if(missing(j)) {
                              if(is.null(ncol(x@ts)))
                                  return(tsmts(x=x@ts[i],timestamp=x@timestamp[i]))
                              else
                                  return(tsmts(x=x@ts[i,],timestamp=x@timestamp[i]))
                          } else
                              return(tsmts(x=x@ts[i,j],timestamp=x@timestamp[i]))
                      } else {
                          ## (2) or a matrice otherwise.
                          if(missing(j)) {
                              if(is.null(ncol(x@ts)))
                                  return(x@ts[i])
                              else
                                  return(x@ts[i,])
                          } else
                              return(x@ts[i,j])
                      }
                  } else {
                      ## (1) but single slice element no not
                      if(missing(j)) {
                          if(is.null(ncol(x@ts)))
                              return(x@ts[i])
                          else
                              return(x@ts[i,])
                          return(x@ts[i,])
                      } else
                          return(x@ts[i,j])
                  }
              }
          })
##
setMethod("[<-",signature("tsmts"),
          function(x,i,j,value) {
              if(missing(i)) {
                  if(missing(j))
                      x@ts[] <- value
                  else
                      x@ts[,j] <- value
              } else {
                  if(missing(j))
                      x@ts[i,] <- value
                  else
                      x@ts[i,j] <- value
              }
              return(x)
          })
##
setMethod("frequency",signature("tsmts"),
          function(x,...) {
              return(frequency(x@ts,...))
          })
##
setMethod("deltat",signature("tsmts"),
          function(x,...) {
              return(deltat(x@ts,...))
          })
##
setMethod("start",signature("tsmts"),
          function(x,...) {
              return(start(x@ts,...))
          })
##
setMethod("end",signature("tsmts"),
          function(x,...) {
              return(end(x@ts,...))
          })
##
setMethod("time",signature(x="tsmts"),
          function(x) {
              return(time(x@ts))
          })
##
setMethod("plot",signature("tsmts"),
          function(x,...) {
              plot(x@ts,...)
              return(invisible(NULL))
          })
##
setMethod("as.ts",signature("tsmts"),
          function(x,...) {
              return(x@ts)
          })
##
setMethod("as.matrix",signature("tsmts"),
          function(x,...) {
              if(!is.null(x@ts))
                  return(matrix(x@ts[],nrow(x@ts),ncol(x@ts),dimnames=dimnames(x@ts)))
              else
                  return(matrix(x@ts[],length(x@ts),1L,dimnames=list(names(x@ts),NULL)))
          })
##
setMethod("head",signature(x="tsmts"),
          function(x,n=5L,...) {
              if(NCOL(x@ts)>1L)
                  return(data.frame(time=time(x@ts)[1L:n],timestamp=x@timestamp[1L:n],head(x@ts,n,...)))
              else
                  return(data.frame(time=time(x@ts)[1L:n],timestamp=x@timestamp[1L:n],series=head(x@ts,n,...)))
          })
##
setMethod("tail",signature(x="tsmts"),
          function(x,n=5L,...) {
              if(NCOL(x@ts)>1L)
                  return(data.frame(time=time(x@ts)[1L:n],timestamp=x@timestamp[1L:n],tail(x@ts,n,...)))
              else
                  return(data.frame(time=time(x@ts)[1L:n],timestamp=x@timestamp[1L:n],series=tail(x@ts,n,...)))
          })
##
setMethod("dim",signature(x="tsmts"),
          function(x) {
              return(dim(x@ts))
          })
##
setMethod("length",signature(x="tsmts"),
          function(x) {
              return(length(x@ts))
          })
##
setMethod("ncol",signature(x="tsmts"),
          function(x) {
              n <- ncol(x@ts)
              if(is.null(n))
                  return(1L)
              else
                  return(n)
          })
##
setMethod("nrow",signature(x="tsmts"),
          function(x) {
              n <- nrow(x@ts)
              if(is.null(n))
                  return(length(x@ts))
              else
                  return(n)
          })
##
setMethod("colnames",signature(x="tsmts"),
          function(x) {
              rns <- colnames(x@ts)
              if(is.null(rns))
                  return(paste("Series",1L:ncol(x)))
              else
                  return(rns)
          })
##
setMethod("colnames<-",signature(x="tsmts"),
          function(x,value) {
              colnames(x@ts) <- value
              return(invisible(NULL))
          })
##
setMethod("rownames",signature(x="tsmts"),
          function(x) {
              return(rownames(x@ts))
          })
##
setMethod("rownames<-",signature(x="tsmts"),
          function(x,value) {
              rownames(x@ts) <- value
              return(invisible(NULL))
          })
##
tref <- data.frame(Year=rep(1900:2099,each=4L),Season=rep(c("Spring","Summer","Autumn","Winter"),25L))
tref[["Time"]] <- as.POSIXlt(c("1900-03-21 01:39:08","1900-06-21 21:39:54","1900-09-23 12:20:18","1900-12-22 06:41:41",
                               "1901-03-21 07:23:41","1901-06-22 03:27:55","1901-09-23 18:09:04","1901-12-22 12:36:44",
                               "1902-03-21 13:16:40","1902-06-22 09:15:15","1902-09-23 23:55:27","1902-12-22 18:35:39",
                               "1903-03-21 19:14:53","1903-06-22 15:05:03","1903-09-24 05:43:48","1903-12-23 00:20:32",
                               "1904-03-21 00:58:39","1904-06-21 20:51:27","1904-09-23 11:40:19","1904-12-22 06:14:03",
                               "1905-03-21 06:57:37","1905-06-22 02:51:29","1905-09-23 17:30:03","1905-12-22 12:03:49",
                               "1906-03-21 12:52:54","1906-06-22 08:41:54","1906-09-23 23:15:05","1906-12-22 17:53:24",
                               "1907-03-21 18:33:05","1907-06-22 14:23:06","1907-09-24 05:08:60","1907-12-22 23:51:39",
                               "1908-03-21 00:27:20","1908-06-21 20:19:09","1908-09-23 10:58:22","1908-12-22 05:33:32",
                               "1909-03-21 06:13:03","1909-06-22 02:05:39","1909-09-23 16:44:37","1909-12-22 11:19:54",
                               "1910-03-21 12:02:58","1910-06-22 07:48:48","1910-09-23 22:30:50","1910-12-22 17:11:50",
                               "1911-03-21 17:54:27","1911-06-22 13:35:37","1911-09-24 04:17:37","1911-12-22 22:53:17",
                               "1912-03-20 23:29:25","1912-06-21 19:16:58","1912-09-23 10:08:06","1912-12-22 04:44:47",
                               "1913-03-21 05:18:02","1913-06-22 01:09:33","1913-09-23 15:52:49","1913-12-22 10:34:57",
                               "1914-03-21 11:10:47","1914-06-22 06:55:06","1914-09-23 21:33:51","1914-12-22 16:22:29",
                               "1915-03-21 16:51:20","1915-06-22 12:29:26","1915-09-24 03:23:52","1915-12-22 22:15:51",
                               "1916-03-20 22:46:56","1916-06-21 18:24:29","1916-09-23 09:14:49","1916-12-22 03:58:37",
                               "1917-03-21 04:37:18","1917-06-22 00:14:23","1917-09-23 15:00:13","1917-12-22 09:45:45",
                               "1918-03-21 10:25:41","1918-06-22 05:59:41","1918-09-23 20:45:43","1918-12-22 15:41:34",
                               "1919-03-21 16:19:11","1919-06-22 11:53:38","1919-09-24 02:35:25","1919-12-22 21:27:08",
                               "1920-03-20 21:59:20","1920-06-21 17:39:52","1920-09-23 08:28:11","1920-12-22 03:17:03",
                               "1921-03-21 03:51:05","1921-06-21 23:35:43","1921-09-23 14:19:48","1921-12-22 09:07:29",
                               "1922-03-21 09:48:38","1922-06-22 05:26:44","1922-09-23 20:09:37","1922-12-22 14:56:58",
                               "1923-03-21 15:28:47","1923-06-22 11:02:48","1923-09-24 02:03:36","1923-12-22 20:53:18",
                               "1924-03-20 21:20:10","1924-06-21 16:59:24","1924-09-23 07:58:18","1924-12-22 02:45:30",
                               "1925-03-21 03:12:12","1925-06-21 22:49:60","1925-09-23 13:43:25","1925-12-22 08:36:40",
                               "1926-03-21 09:01:12","1926-06-22 04:30:03","1926-09-23 19:26:38","1926-12-22 14:33:23",
                               "1927-03-21 14:59:07","1927-06-22 10:22:13","1927-09-24 01:16:57","1927-12-22 20:18:30",
                               "1928-03-20 20:44:16","1928-06-21 16:06:27","1928-09-23 07:05:31","1928-12-22 02:03:41",
                               "1929-03-21 02:34:52","1929-06-21 22:00:38","1929-09-23 12:52:20","1929-12-22 07:52:46",
                               "1930-03-21 08:29:47","1930-06-22 03:52:51","1930-09-23 18:35:57","1930-12-22 13:39:34",
                               "1931-03-21 14:06:20","1931-06-22 09:28:06","1931-09-24 00:23:20","1931-12-22 19:29:37",
                               "1932-03-20 19:53:38","1932-06-21 15:22:40","1932-09-23 06:15:55","1932-12-22 01:14:17",
                               "1933-03-21 01:43:08","1933-06-21 21:11:51","1933-09-23 12:01:10","1933-12-22 06:57:32",
                               "1934-03-21 07:27:56","1934-06-22 02:47:57","1934-09-23 17:45:13","1934-12-22 12:49:27",
                               "1935-03-21 13:17:47","1935-06-22 08:37:56","1935-09-23 23:38:11","1935-12-22 18:37:08",
                               "1936-03-20 18:57:52","1936-06-21 14:21:39","1936-09-23 05:25:59","1936-12-22 00:26:43",
                               "1937-03-21 00:45:05","1937-06-21 20:12:01","1937-09-23 11:12:57","1937-12-22 06:21:41",
                               "1938-03-21 06:43:06","1938-06-22 02:03:37","1938-09-23 16:59:31","1938-12-22 12:13:25",
                               "1939-03-21 12:28:29","1939-06-22 07:39:27","1939-09-23 22:49:28","1939-12-22 18:06:00",
                               "1940-03-20 18:23:45","1940-06-21 13:36:27","1940-09-23 04:45:36","1940-12-21 23:54:46",
                               "1941-03-21 00:20:24","1941-06-21 19:33:19","1941-09-23 10:32:47","1941-12-22 05:44:11",
                               "1942-03-21 06:10:39","1942-06-22 01:16:17","1942-09-23 16:16:29","1942-12-22 11:39:35",
                               "1943-03-21 12:02:38","1943-06-22 07:12:21","1943-09-23 22:11:45","1943-12-22 17:29:08",
                               "1944-03-20 17:48:37","1944-06-21 13:02:19","1944-09-23 04:01:39","1944-12-21 23:14:50",
                               "1945-03-20 23:37:13","1945-06-21 18:52:05","1945-09-23 09:49:48","1945-12-22 05:03:36",
                               "1946-03-21 05:32:42","1946-06-22 00:44:21","1946-09-23 15:40:39","1946-12-22 10:53:21",
                               "1947-03-21 11:12:42","1947-06-22 06:18:50","1947-09-23 21:28:38","1947-12-22 16:42:48",
                               "1948-03-20 16:56:48","1948-06-21 12:10:37","1948-09-23 03:21:43","1948-12-21 22:33:18",
                               "1949-03-20 22:48:03","1949-06-21 18:02:47","1949-09-23 09:05:51","1949-12-22 04:22:54",
                               "1950-03-21 04:35:10","1950-06-21 23:36:04","1950-09-23 14:43:35","1950-12-22 10:13:22",
                               "1951-03-21 10:25:44","1951-06-22 05:24:51","1951-09-23 20:36:52","1951-12-22 16:00:05",
                               "1952-03-20 16:13:46","1952-06-21 11:12:34","1952-09-23 02:23:41","1952-12-21 21:43:10",
                               "1953-03-20 22:00:31","1953-06-21 16:59:58","1953-09-23 08:05:55","1953-12-22 03:31:29",
                               "1954-03-21 03:53:26","1954-06-21 22:54:04","1954-09-23 13:55:17","1954-12-22 09:24:22",
                               "1955-03-21 09:35:07","1955-06-22 04:31:23","1955-09-23 19:40:54","1955-12-22 15:10:55",
                               "1956-03-20 15:20:18","1956-06-21 10:23:46","1956-09-23 01:35:04","1956-12-21 20:59:30",
                               "1957-03-20 21:16:30","1957-06-21 16:20:32","1957-09-23 07:26:05","1957-12-22 02:48:38",
                               "1958-03-21 03:05:49","1958-06-21 21:56:55","1958-09-23 13:08:52","1958-12-22 08:39:44",
                               "1959-03-21 08:54:33","1959-06-22 03:49:47","1959-09-23 19:08:28","1959-12-22 14:34:21",
                               "1960-03-20 14:42:41","1960-06-21 09:42:19","1960-09-23 00:58:52","1960-12-21 20:25:57",
                               "1961-03-20 20:32:07","1961-06-21 15:30:08","1961-09-23 06:42:28","1961-12-22 02:19:30",
                               "1962-03-21 02:29:34","1962-06-21 21:24:08","1962-09-23 12:35:14","1962-12-22 08:15:17",
                               "1963-03-21 08:19:42","1963-06-22 03:04:03","1963-09-23 18:23:31","1963-12-22 14:01:55",
                               "1964-03-20 14:09:53","1964-06-21 08:56:50","1964-09-23 00:16:41","1964-12-21 19:49:34",
                               "1965-03-20 20:04:47","1965-06-21 14:55:43","1965-09-23 06:06:01","1965-12-22 01:40:27",
                               "1966-03-21 01:52:56","1966-06-21 20:33:24","1966-09-23 11:43:10","1966-12-22 07:28:12",
                               "1967-03-21 07:36:50","1967-06-22 02:22:52","1967-09-23 17:38:04","1967-12-22 13:16:20",
                               "1968-03-20 13:22:02","1968-06-21 08:13:18","1968-09-22 23:26:12","1968-12-21 18:59:48",
                               "1969-03-20 19:08:07","1969-06-21 13:55:05","1969-09-23 05:06:56","1969-12-22 00:43:44",
                               "1970-03-21 00:56:21","1970-06-21 19:42:41","1970-09-23 10:58:59","1970-12-22 06:35:42",
                               "1971-03-21 06:38:10","1971-06-22 01:19:37","1971-09-23 16:44:55","1971-12-22 12:23:57",
                               "1972-03-20 12:21:26","1972-06-21 07:06:12","1972-09-22 22:32:47","1972-12-21 18:12:57",
                               "1973-03-20 18:12:29","1973-06-21 13:00:37","1973-09-23 04:21:09","1973-12-22 00:07:45",
                               "1974-03-21 00:06:39","1974-06-21 18:37:38","1974-09-23 09:58:27","1974-12-22 05:55:59",
                               "1975-03-21 05:56:42","1975-06-22 00:26:28","1975-09-23 15:55:14","1975-12-22 11:45:36",
                               "1976-03-20 11:49:37","1976-06-21 06:24:14","1976-09-22 21:48:13","1976-12-21 17:35:10",
                               "1977-03-20 17:42:17","1977-06-21 12:13:47","1977-09-23 03:29:17","1977-12-21 23:23:11",
                               "1978-03-20 23:33:35","1978-06-21 18:09:35","1978-09-23 09:25:26","1978-12-22 05:20:60",
                               "1979-03-21 05:21:57","1979-06-21 23:56:12","1979-09-23 15:16:25","1979-12-22 11:09:47",
                               "1980-03-20 11:09:42","1980-06-21 05:47:02","1980-09-22 21:08:43","1980-12-21 16:56:07",
                               "1981-03-20 17:02:52","1981-06-21 11:44:42","1981-09-23 03:05:13","1981-12-21 22:50:34",
                               "1982-03-20 22:55:51","1982-06-21 17:23:01","1982-09-23 08:46:13","1982-12-22 04:38:11",
                               "1983-03-21 04:38:46","1983-06-21 23:08:42","1983-09-23 14:41:38","1983-12-22 10:29:57",
                               "1984-03-20 10:24:21","1984-06-21 05:02:15","1984-09-22 20:32:54","1984-12-21 16:22:50",
                               "1985-03-20 16:13:45","1985-06-21 10:44:09","1985-09-23 02:07:28","1985-12-21 22:07:41",
                               "1986-03-20 22:02:43","1986-06-21 16:29:59","1986-09-23 07:58:53","1986-12-22 04:02:09",
                               "1987-03-21 03:51:59","1987-06-21 22:10:46","1987-09-23 13:45:17","1987-12-22 09:45:54",
                               "1988-03-20 09:38:37","1988-06-21 03:56:33","1988-09-22 19:28:52","1988-12-21 15:27:54",
                               "1989-03-20 15:28:16","1989-06-21 09:53:02","1989-09-23 01:19:37","1989-12-21 21:22:02",
                               "1990-03-20 21:19:17","1990-06-21 15:32:49","1990-09-23 06:55:31","1990-12-22 03:07:01",
                               "1991-03-21 03:01:57","1991-06-21 21:18:48","1991-09-23 12:48:06","1991-12-22 08:53:40",
                               "1992-03-20 08:48:04","1992-06-21 03:14:10","1992-09-22 18:42:47","1992-12-21 14:43:15",
                               "1993-03-20 14:40:39","1993-06-21 08:59:45","1993-09-23 00:22:29","1993-12-21 20:25:50",
                               "1994-03-20 20:28:01","1994-06-21 14:47:33","1994-09-23 06:19:14","1994-12-22 02:22:44",
                               "1995-03-21 02:14:26","1995-06-21 20:34:23","1995-09-23 12:12:60","1995-12-22 08:16:49",
                               "1996-03-20 08:03:05","1996-06-21 02:23:45","1996-09-22 18:00:07","1996-12-21 14:05:54",
                               "1997-03-20 13:54:40","1997-06-21 08:19:56","1997-09-22 23:55:47","1997-12-21 20:07:03",
                               "1998-03-20 19:54:32","1998-06-21 14:02:35","1998-09-23 05:37:12","1998-12-22 01:56:28",
                               "1999-03-21 01:45:49","1999-06-21 19:49:07","1999-09-23 11:31:31","1999-12-22 07:43:49",
                               "2000-03-20 07:35:15","2000-06-21 01:47:43","2000-09-22 17:27:35","2000-12-21 13:37:26",
                               "2001-03-20 13:30:40","2001-06-21 07:37:41","2001-09-22 23:04:26","2001-12-21 19:21:27",
                               "2002-03-20 19:16:05","2002-06-21 13:24:21","2002-09-23 04:55:20","2002-12-22 01:14:19",
                               "2003-03-21 00:59:41","2003-06-21 19:10:23","2003-09-23 10:46:44","2003-12-22 07:03:43",
                               "2004-03-20 06:48:32","2004-06-21 00:56:46","2004-09-22 16:29:44","2004-12-21 12:41:30",
                               "2005-03-20 12:33:18","2005-06-21 06:46:00","2005-09-22 22:23:02","2005-12-21 18:34:49",
                               "2006-03-20 18:25:26","2006-06-21 12:25:43","2006-09-23 04:03:13","2006-12-22 00:21:57",
                               "2007-03-21 00:07:15","2007-06-21 18:06:16","2007-09-23 09:51:04","2007-12-22 06:07:39",
                               "2008-03-20 05:48:07","2008-06-20 23:59:11","2008-09-22 15:44:18","2008-12-21 12:03:34",
                               "2009-03-20 11:43:26","2009-06-21 05:45:19","2009-09-22 21:18:23","2009-12-21 17:46:36",
                               "2010-03-20 17:31:59","2010-06-21 11:28:11","2010-09-23 03:08:48","2010-12-21 23:38:15",
                               "2011-03-20 23:20:29","2011-06-21 17:16:16","2011-09-23 09:04:23","2011-12-22 05:29:48",
                               "2012-03-20 05:14:09","2012-06-20 23:08:32","2012-09-22 14:48:43","2012-12-21 11:11:21",
                               "2013-03-20 11:01:38","2013-06-21 05:03:40","2013-09-22 20:43:51","2013-12-21 17:10:44",
                               "2014-03-20 16:56:48","2014-06-21 10:50:56","2014-09-23 02:28:46","2014-12-21 23:02:43",
                               "2015-03-20 22:44:49","2015-06-21 16:37:36","2015-09-23 08:20:14","2015-12-22 04:47:38",
                               "2016-03-20 04:29:51","2016-06-20 22:33:51","2016-09-22 14:20:47","2016-12-21 10:43:50",
                               "2017-03-20 10:28:17","2017-06-21 04:23:48","2017-09-22 20:01:26","2017-12-21 16:27:35",
                               "2018-03-20 16:15:05","2018-06-21 10:06:55","2018-09-23 01:53:43","2018-12-21 22:22:22",
                               "2019-03-20 21:58:02","2019-06-21 15:53:51","2019-09-23 07:49:46","2019-12-22 04:19:02",
                               "2020-03-20 03:49:11","2020-06-20 21:43:15","2020-09-22 13:30:13","2020-12-21 10:01:55",
                               "2021-03-20 09:37:01","2021-06-21 03:31:43","2021-09-22 19:20:38","2021-12-21 15:58:51",
                               "2022-03-20 15:32:56","2022-06-21 09:13:22","2022-09-23 01:03:13","2022-12-21 21:47:44",
                               "2023-03-20 21:23:56","2023-06-21 14:57:19","2023-09-23 06:49:29","2023-12-22 03:26:52",
                               "2024-03-20 03:05:53","2024-06-20 20:50:28","2024-09-22 12:43:08","2024-12-21 09:20:02",
                               "2025-03-20 09:00:56","2025-06-21 02:41:42","2025-09-22 18:18:47","2025-12-21 15:02:32",
                               "2026-03-20 14:45:22","2026-06-21 08:23:55","2026-09-23 00:04:38","2026-12-21 20:49:39",
                               "2027-03-20 20:24:05","2027-06-21 14:10:14","2027-09-23 06:01:06","2027-12-22 02:41:33",
                               "2028-03-20 02:16:30","2028-06-20 20:01:22","2028-09-22 11:44:40","2028-12-21 08:19:02",
                               "2029-03-20 08:01:19","2029-06-21 01:47:38","2029-09-22 17:37:50","2029-12-21 14:13:27",
                               "2030-03-20 13:51:25","2030-06-21 07:30:37","2030-09-22 23:26:12","2030-12-21 20:08:56",
                               "2031-03-20 19:40:16","2031-06-21 13:16:25","2031-09-23 05:14:35","2031-12-22 01:54:51",
                               "2032-03-20 01:21:09","2032-06-20 19:08:02","2032-09-22 11:10:09","2032-12-21 07:55:12",
                               "2033-03-20 07:21:58","2033-06-21 01:00:22","2033-09-22 16:50:54","2033-12-21 13:45:14",
                               "2034-03-20 13:16:42","2034-06-21 06:43:24","2034-09-22 22:38:47","2034-12-21 19:33:13",
                               "2035-03-20 19:01:55","2035-06-21 12:32:19","2035-09-23 04:38:07","2035-12-22 01:30:04",
                               "2036-03-20 01:01:60","2036-06-20 18:31:23","2036-09-22 10:22:28","2036-12-21 07:12:02",
                               "2037-03-20 06:49:24","2037-06-21 00:21:35","2037-09-22 16:12:13","2037-12-21 13:06:53",
                               "2038-03-20 12:39:45","2038-06-21 06:08:31","2038-09-22 22:01:23","2038-12-21 19:01:27",
                               "2039-03-20 18:31:08","2039-06-21 11:56:31","2039-09-23 03:48:42","2039-12-22 00:39:41",
                               "2040-03-20 00:10:46","2040-06-20 17:45:28","2040-09-22 09:43:59","2040-12-21 06:31:55",
                               "2041-03-20 06:05:52","2041-06-20 23:34:55","2041-09-22 15:25:36","2041-12-21 12:17:23",
                               "2042-03-20 11:52:21","2042-06-21 05:14:52","2042-09-22 21:10:35","2042-12-21 18:03:06",
                               "2043-03-20 17:26:49","2043-06-21 10:57:24","2043-09-23 03:05:57","2043-12-22 00:00:16",
                               "2044-03-19 23:19:33","2044-06-20 16:50:08","2044-09-22 08:46:52","2044-12-21 05:42:36",
                               "2045-03-20 05:06:36","2045-06-20 22:32:53","2045-09-22 14:31:55","2045-12-21 11:34:07",
                               "2046-03-20 10:56:50","2046-06-21 04:13:38","2046-09-22 20:20:42","2046-12-21 17:27:28",
                               "2047-03-20 16:51:37","2047-06-21 10:02:27","2047-09-23 02:07:03","2047-12-21 23:06:12",
                               "2048-03-19 22:32:47","2048-06-20 15:52:52","2048-09-22 07:59:36","2048-12-21 05:01:13",
                               "2049-03-20 04:27:33","2049-06-20 21:46:15","2049-09-22 13:41:33","2049-12-21 10:51:07",
                               "2050-03-20 10:18:30","2050-06-21 03:31:57","2050-09-22 19:27:27","2050-12-21 16:37:39",
                               "2051-03-20 15:58:06","2051-06-21 09:17:35","2051-09-23 01:26:18","2051-12-21 22:33:04",
                               "2052-03-19 21:55:01","2052-06-20 15:15:08","2052-09-22 07:14:38","2052-12-21 04:16:09",
                               "2053-03-20 03:46:18","2053-06-20 21:03:04","2053-09-22 13:05:14","2053-12-21 10:08:53",
                               "2054-03-20 09:33:24","2054-06-21 02:46:07","2054-09-22 18:58:26","2054-12-21 16:08:55",
                               "2055-03-20 15:27:34","2055-06-21 08:38:49","2055-09-23 00:47:42","2055-12-21 21:54:34",
                               "2056-03-19 21:10:01","2056-06-20 14:27:10","2056-09-22 06:38:28","2056-12-21 03:50:35",
                               "2057-03-20 03:06:52","2057-06-20 20:18:02","2057-09-22 12:22:14","2057-12-21 09:41:49",
                               "2058-03-20 09:03:58","2058-06-21 02:03:01","2058-09-22 18:07:22","2058-12-21 15:23:57",
                               "2059-03-20 14:43:12","2059-06-21 07:46:14","2059-09-23 00:02:30","2059-12-21 21:16:56",
                               "2060-03-19 20:37:28","2060-06-20 13:44:35","2060-09-22 05:47:09","2060-12-21 03:00:24",
                               "2061-03-20 02:25:13","2061-06-20 19:31:11","2061-09-22 11:30:21","2061-12-21 08:47:49",
                               "2062-03-20 08:06:27","2062-06-21 01:10:21","2062-09-22 17:18:53","2062-12-21 14:41:39",
                               "2063-03-20 13:58:09","2063-06-21 07:00:53","2063-09-22 23:07:11","2063-12-21 20:20:05",
                               "2064-03-19 19:37:35","2064-06-20 12:44:38","2064-09-22 04:56:01","2064-12-21 02:07:45",
                               "2065-03-20 01:27:09","2065-06-20 18:31:27","2065-09-22 10:41:35","2065-12-21 07:59:45",
                               "2066-03-20 07:18:47","2066-06-21 00:15:22","2066-09-22 16:25:59","2066-12-21 13:44:31",
                               "2067-03-20 12:52:35","2067-06-21 05:54:59","2067-09-22 22:18:38","2067-12-21 19:42:06",
                               "2068-03-19 18:47:57","2068-06-20 11:52:45","2068-09-22 04:05:45","2068-12-21 01:31:39",
                               "2069-03-20 00:44:01","2069-06-20 17:40:16","2069-09-22 09:50:51","2069-12-21 07:21:03",
                               "2070-03-20 06:33:52","2070-06-20 23:21:34","2070-09-22 15:43:48","2070-12-21 13:18:19",
                               "2071-03-20 12:33:38","2071-06-21 05:19:48","2071-09-22 21:36:43","2071-12-21 19:02:52",
                               "2072-03-19 18:20:01","2072-06-20 11:12:46","2072-09-22 03:26:48","2072-12-21 00:55:00",
                               "2073-03-20 00:12:18","2073-06-20 17:05:59","2073-09-22 09:14:16","2073-12-21 06:49:41",
                               "2074-03-20 06:07:50","2074-06-20 22:57:25","2074-09-22 15:02:46","2074-12-21 12:34:14",
                               "2075-03-20 11:45:33","2075-06-21 04:39:24","2075-09-22 20:57:49","2075-12-21 18:26:05",
                               "2076-03-19 17:37:49","2076-06-20 10:35:46","2076-09-22 02:49:14","2076-12-21 00:12:23",
                               "2077-03-19 23:30:05","2077-06-20 16:22:27","2077-09-22 08:34:51","2077-12-21 05:59:50",
                               "2078-03-20 05:09:50","2078-06-20 21:56:57","2078-09-22 14:23:32","2078-12-21 11:56:59",
                               "2079-03-20 10:59:41","2079-06-21 03:48:20","2079-09-22 20:12:11","2079-12-21 17:43:03",
                               "2080-03-19 16:43:08","2080-06-20 09:33:07","2080-09-22 01:55:27","2080-12-20 23:31:52",
                               "2081-03-19 22:33:18","2081-06-20 15:15:26","2081-09-22 07:36:52","2081-12-21 05:21:35",
                               "2082-03-20 04:29:39","2082-06-20 21:02:20","2082-09-22 13:22:01","2082-12-21 11:03:44",
                               "2083-03-20 10:09:34","2083-06-21 02:42:57","2083-09-22 19:10:42","2083-12-21 16:52:27",
                               "2084-03-19 15:58:32","2084-06-20 08:39:39","2084-09-22 00:58:11","2084-12-20 22:40:22",
                               "2085-03-19 21:52:37","2085-06-20 14:31:55","2085-09-22 06:42:36","2085-12-21 04:27:51",
                               "2086-03-20 03:34:22","2086-06-20 20:08:43","2086-09-22 12:31:20","2086-12-21 10:21:48",
                               "2087-03-20 09:27:26","2087-06-21 02:05:06","2087-09-22 18:27:27","2087-12-21 16:07:39",
                               "2088-03-19 15:16:10","2088-06-20 07:55:51","2088-09-22 00:17:26","2088-12-20 21:55:21",
                               "2089-03-19 21:05:45","2089-06-20 13:42:08","2089-09-22 06:06:06","2089-12-21 03:51:14",
                               "2090-03-20 03:01:05","2090-06-20 19:35:05","2090-09-22 11:58:32","2090-12-21 09:42:47",
                               "2091-03-20 08:41:04","2091-06-21 01:18:08","2091-09-22 17:50:04","2091-12-21 15:37:46",
                               "2092-03-19 14:32:47","2092-06-20 07:14:11","2092-09-21 23:41:02","2092-12-20 21:31:09",
                               "2093-03-19 20:33:44","2093-06-20 13:06:17","2093-09-22 05:28:08","2093-12-21 03:19:59",
                               "2094-03-20 02:20:47","2094-06-20 18:41:32","2094-09-22 11:15:47","2094-12-21 09:12:34",
                               "2095-03-20 08:14:10","2095-06-21 00:38:04","2095-09-22 17:10:20","2095-12-21 15:00:03",
                               "2096-03-19 14:02:07","2096-06-20 06:29:59","2096-09-21 22:53:56","2096-12-20 20:45:26",
                               "2097-03-19 19:47:35","2097-06-20 12:12:35","2097-09-22 04:35:03","2097-12-21 02:36:38",
                               "2098-03-20 01:39:37","2098-06-20 18:02:10","2098-09-22 10:23:24","2098-12-21 08:20:01",
                               "2099-03-20 07:16:53","2099-06-20 23:40:49","2099-09-22 16:10:16","2099-12-21 14:03:31"),
                             tz="UTC")
##
atime <- function(tsmtsobj,tref) {
    treft <- as.numeric(tref[,"Time"])
    input <- tsmtsobj@timestamp
    output <- tsmts(x=matrix(NA,length(input),2L,dimnames=list(NULL,c("TM_A","TM_B"))),
                    timestamp=input)
    for(i in 1L:length(input)) {
        ## i <- 1L
        x <- as.numeric(input[i])
        df <- x-treft
        nearest <- which.min(abs(df))
        nearest <- nearest + if(df[nearest]>0) c(0L,1L) else c(-1L,0L)
        output[i,] <- switch(as.character(tref[nearest[1L],"Season"]),
                             Spring = {
                                 c((x-treft[nearest[1L]])/(treft[nearest[2L]]-treft[nearest[1L]]),
                                   1-(x-treft[nearest[1L]])/(treft[nearest[2L]]-treft[nearest[1L]]))
                             },
                             Summer = {
                                 c(1-(x-treft[nearest[1L]])/(treft[nearest[2L]]-treft[nearest[1L]]),
                                   -(x-treft[nearest[1L]])/(treft[nearest[2L]]-treft[nearest[1L]]))
                             },
                             Autumn = {
                                 c(-(x-treft[nearest[1L]])/(treft[nearest[2L]]-treft[nearest[1L]]),
                                   (x-treft[nearest[1L]])/(treft[nearest[2L]]-treft[nearest[1L]])-1)
                             },
                             Winter = {
                                 c((x-treft[nearest[1L]])/(treft[nearest[2L]]-treft[nearest[1L]])-1,
                                   (x-treft[nearest[1L]])/(treft[nearest[2L]]-treft[nearest[1L]]))
                             })
    }
    return(output)
}
##






##
if(FALSE){
##
setClass("ARWtNet",representation(data="tsmts",terms="factor",settings="list",preliminary="tsmts"))
##
ARWtNet <- function(y,x,width,filter="d2",cutoffs=1L,sample=2^(0L:log2(width)),na.rm=TRUE) {
    res <- floor(log2(width))
    n <- nrow(y)
    ans <- new("ARWtNet",
               data=tsmts(x=matrix(NA,n-width,
                                   ncol(y)+length(sample)+if(missing(x)) 0L else ncol(x),
                                   dimnames=list(NULL,c(colnames(y),
                                                        paste("mri",1L:length(sample),sep="_"),
                                                        if(!missing(x)) colnames(x)))),
                          timestamp=y@timestamp[(width+1L):n]),
               terms=factor(c(rep("response",ncol(y)),
                              rep("mri",length(sample)),
                              rep("descriptor",if(missing(x)) 0L else ncol(x))),
                            levels=c("response","mri","descriptor","cvfold")),
               settings=list(filter=filter,width=width,
                             cutoffs=c(cutoffs,rep(1,res-length(cutoffs))),
                             sample=sample),
               preliminary=tsmts(x=if(ncol(y)>1L) matrix(NA,width,ncol(y),dimnames=list(NULL,colnames(y)))
                                   else numeric(width),
                                 timestamp=y@timestamp[1L:width]))
    ans@preliminary@ts[] <- if(ncol(y)>1L) y@ts[1L:width,] else y@ts[1L:width]
    ns <- length(sample)
    nc <- length(ans@settings$cutoffs)
    ans@data@ts[,ans@terms=="response"] <-
        if(ncol(y)>1L) y@ts[(width+1L):n,] else y@ts[(width+1L):n]
    if(!missing(x))
        ans@data@ts[,ans@terms=="descriptor"] <-
            if(ncol(x)>1) x@ts[(width+1L):n,] else x@ts[(width+1L):n]
    for(i in 1L:(n-width)) {
        rwy <- rev(y@ts[i:(i+width-1L)])
        if(all(!is.na(rwy))) {
            dwt1 <- wavelets::dwt(X=rwy,filter=filter,n.levels=res,boundary="periodic")
            for(j in 1L:nc)
                dwt1@W[[j]][-cutoffs[j]] <- 0
             ans@data@ts[i,ans@terms=="mri"] <- rev(wavelets::idwt(dwt1))[width-sample+1L]
        }
    }
    if(na.rm) {
        na.ok <- rowSums(is.na(ans@data@ts[,ans@terms!="mri"]))==0
        if(!all(na.ok))
            ans@data <- ans@data[na.ok,]
    }
    return(ans)
}
##
setMethod("print",signature(x="ARWtNet"),
          function(x,...) {
              cat("ARWtNet:")
              cat("\nOriginal time series spanning: ",as.character(min(x@data@timestamp))," to ",
                  as.character(max(x@data@timestamp)),", time step: ",deltat(x@data@ts),sep="")
              cat("\nWidth: ",x@settings$width,", multi-resolution impulse filter: ",x@settings$filter,
                  " wavelet, with\ncutoff point(s) set at: ",paste(x@settings$cutoffs,collapse=" "),
                  " and\nsampling at points(s): ",paste(x@settings$sample,collapse=" "),
                  " before present","\n",sep="")
              cat(if(!any(x@terms=="descriptor")) "no auxiliary series"
                  else paste(sum(x@terms=="descriptor"),"auxiliary series:",
                             paste(colnames(x@data@ts)[x@terms=="descriptor"],collapse=" ")))
              cat("\nSample size: ",nrow(x@data),", descriptors: ",
                  paste(colnames(x@data@ts)[x@terms=="mri"|x@terms=="descriptor"],collapse=", "),sep="")
              cat(if(!any(x@terms=="cvfold")) "\nNo cross-validation fold assignment"
                  else paste(sum(x@terms=="descriptor"),"\nCross-validation fold assignment(s):",
                             paste(colnames(x@data@ts)[x@terms=="cvfold"],collapse=" ")))
              cat("\n")
               return(invisible(NULL))
          })
##
setMethod("frequency",signature("ARWtNet"),
          function(x,...) {
              return(frequency(x@data@ts,...))
          })
##
setMethod("deltat",signature("ARWtNet"),
          function(x,...) {
              return(deltat(x@data@ts,...))
          })
##
setMethod("start",signature("ARWtNet"),
          function(x,...) {
              return(start(x@data@ts,...))
          })
##
setMethod("end",signature("ARWtNet"),
          function(x,...) {
              return(end(x@data@ts,...))
          })
##
setMethod("time",signature(x="ARWtNet"),
          function(x) {
              return(time(x@data@ts))
          })
##
setMethod("plot",signature("ARWtNet"),
          function(x,step,xlim,type="l",lwd=1,las=1L,col=c("black","red"),xlab="",ylab="",...) {
              if(missing(xlim))
                  xlim <- c(-x@settings$width,1)*deltat(x)
              plot(y=x@data@ts[,x@terms=="response"],x=time(x@data),
                   xlim=time(x@data)[step]+xlim,type=type,lwd=lwd,las=las,col=col[1L],
                   xlab=xlab,ylab=ylab)
              abline(v=time(x@data)[step],lty=3L,lwd=lwd,col=col[1L])
              points(y=x@data[step,x@terms=="mri"],
                     x=time(x@data)[step]-x@settings$sample*deltat(x),pch=21L,bg=col[2L])
              return(invisible(NULL))
          })
##
setMethod("as.ts",signature("ARWtNet"),
          function(x,...) {
              return(x@data@ts)
          })
##
setMethod("as.matrix",signature("ARWtNet"),
          function(x,...) {
              if(!is.null(x@data@ts))
                  return(matrix(x@data@ts[],nrow(x@data@ts),ncol(x@data@ts),dimnames=dimnames(x@data@ts)))
              else
                  return(matrix(x@data@ts[],length(x@data@ts),1L,dimnames=list(names(x@data@ts),NULL)))
          })
##
setMethod("head",signature(x="ARWtNet"),
          function(x,n=5L,...) {
              if(NCOL(x@data@ts)>1L)
                  return(data.frame(time=time(x@data@ts)[1L:n],timestamp=x@data@timestamp[1L:n],head(x@data@ts,n,...)))
              else
                  return(data.frame(time=time(x@data@ts)[1L:n],timestamp=x@data@timestamp[1L:n],series=head(x@data@ts,n,...)))
          })
##
setMethod("tail",signature(x="ARWtNet"),
          function(x,n=5L,...) {
              if(NCOL(x@data@ts)>1L)
                  return(data.frame(time=time(x@data@ts)[1L:n],timestamp=x@data@timestamp[1L:n],tail(x@data@ts,n,...)))
              else
                  return(data.frame(time=time(x@data@ts)[1L:n],timestamp=x@data@timestamp[1L:n],series=tail(x@data@ts,n,...)))
          })
##
setMethod("dim",signature(x="ARWtNet"),
          function(x) {
              return(dim(x@data@ts))
          })
##
setMethod("length",signature(x="ARWtNet"),
          function(x) {
              return(length(x@data@ts))
          })
##
setMethod("ncol",signature(x="ARWtNet"),
          function(x) {
              n <- ncol(x@data@ts)
              if(is.null(n))
                  return(1L)
              else
                  return(n)
          })
##
setMethod("nrow",signature(x="ARWtNet"),
          function(x) {
              n <- nrow(x@data@ts)
              if(is.null(n))
                  return(length(x@data@ts))
              else
                  return(n)
          })
##
setMethod("colnames",signature(x="ARWtNet"),
          function(x) {
              rns <- colnames(x@data@ts)
              if(is.null(rns))
                  return(paste("Series",1L:ncol(x)))
              else
                  return(rns)
          })
##
setMethod("colnames<-",signature(x="ARWtNet"),
          function(x,value) {
              colnames(x@data@ts) <- value
              return(invisible(NULL))
          })
##
setMethod("rownames",signature(x="ARWtNet"),
          function(x) {
              return(rownames(x@data@ts))
          })
##
setMethod("rownames<-",signature(x="ARWtNet"),
          function(x,value) {
              rownames(x@data@ts) <- value
              return(invisible(NULL))
          })
##
ARWtNet_add_cvfold <- function(x,nfold) {
    if(class(x)!="ARWtNet")
        stop("Parameter 'x' must be of class 'ARWtNet'!")
    nms <- colnames(x)
    x@data@ts <- cbind(x@data@ts,rep(1L:nfold,length.out=nrow(x)))
    colnames(x@data@ts) <- c(nms,paste("cvold",sum(x@terms=="cvfold")+1L,sep="_"))
    x@terms[length(x@terms)+1L] <- "cvfold"
    return(x)
}
##
ARWtNet_rm_cvfold <- function(x,cvfold=1L) {
    if(class(x)!="ARWtNet")
        stop("Parameter 'x' must be of class 'ARWtNet'!")
    wh <- which(x@terms=="cvfold")[cvfold]
    if(!is.na(wh)) {
        x@data@ts <- x@data@ts[,-wh]
        x@terms <- x@terms[-wh]
    }
    return(x)
}
##
### Attention: simplifiée par rapport à la version précédente.
initDLARdata <- function(x) {
    if(!h2o::h2o.clusterIsUp())
        stop("h2o cluster must first be started!")
    if(!is.null(x$model)) {
        cat("Transfering model data to the h2o instance:\n")
        x[["h2oData"]] <- h2o::as.h2o(as.matrix(x$model),destination_frame="Model")
    }
    return(x)
}
##
removeDLARdata <- function(x) {
    if(!h2o::h2o.clusterIsUp())
        stop("h2o cluster must first be started!")
    if(!is.null(x$model)) {
        cat("Try removing model data from the h2o instance:")
        tmp <- try(h2o::h2o.rm(x$h2oData))
        if(class(tmp)!="try-error") cat(" Ok.\n")
        else cat(" Fail!\n")
    }
    return(x)
}
##














if(FALSE){
##
profileplot <- function(y,x,z,bound=c(0.25,1.25),lp) {
  tmp <- range(z)
  plot(y=y,x=x,cex=bound[1L]+(bound[2L]-bound[1L])*(z-tmp[1L])/(tmp[2L]-tmp[1L]))
  legend(x=lp$x,y=lp$y,pch=rep(1L,5L),legend=round(quantile(z,seq(0,1,0.25)),2),
         pt.cex=bound[1L]+(bound[2L]-bound[1L])*(quantile(z,seq(0,1,0.25))-tmp[1L])/(tmp[2L]-tmp[1L]))
}
##
}
}
